#!/bin/sh
set -e
dir=/usr/src/php

usage() {
	echo "usage: $0 COMMAND"
	echo
	echo "Manage php source tarball lifecycle."
	echo
	echo "Commands:"
	echo "   extract  extract php source tarball into directory $dir if not already done."
	echo "   delete   delete extracted php source located into $dir if not already done."
	echo
}

case "$1" in
	extract)
		if [ -e "$dir" -a ! -d "$dir" ] ; then
			echo >&2 "$dir exists and is not a directory"
			exit 1
		fi
        if [[ ! -d "$dir" || $(ls -1 "$dir") == "ext" ]]; then
			mkdir -p "$dir"
			tar -Jxf /usr/src/php.tar.xz -C "$dir" --strip-components=1

			if [ ! -f /usr/src/php-available-exts ]; then
				find "$dir/ext" \
						-mindepth 2 \
						-maxdepth 2 \
						-type f \
						-name 'config.m4' \
					| xargs -n1 dirname | xargs -n1 basename | sort \
				> /usr/src/php-available-exts
			fi
		fi
		;;
	delete)
		rm -rf "$dir"
		# To maintain BC we create this directory because many people
		# were extracting some of their custom extensions in this directory
		# See https://github.com/docker-library/php/issues/266
		# Was breaked by https://github.com/docker-library/php/pull/256
		mkdir -p "$dir/ext"
		;;
	*)
		usage
		exit 1
		;;
esac
