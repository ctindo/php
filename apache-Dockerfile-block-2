COPY apache2-foreground /usr/local/bin/
WORKDIR /var/www/html

RUN set -ex \
	&& cd /usr/local/etc \
	&& if [ -d php-fpm.d ]; then \
		# for some reason, upstream's php-fpm.conf.default has "include=NONE/etc/php-fpm.d/*.conf"
		sed 's!=NONE/!=!g' php-fpm.conf.default | tee php-fpm.conf > /dev/null; \
		cp php-fpm.d/www.conf.default php-fpm.d/www.conf; \
	else \
		# PHP 5.x doesn't use "include=" by default, so we'll create our own simple config that mimics PHP 7+ for consistency
		mkdir php-fpm.d; \
		cp php-fpm.conf.default php-fpm.d/www.conf; \
		{ \
			echo '[global]'; \
			echo 'include=etc/php-fpm.d/*.conf'; \
		} | tee php-fpm.conf; \
	fi \
	&& { \
		echo '[global]'; \
		echo 'error_log = /proc/self/fd/2'; \
		echo; echo '; https://github.com/docker-library/php/pull/725#issuecomment-443540114'; echo 'log_limit = 8192'; \
		echo; \
		echo '[www]'; \
		echo 'clear_env = no'; \
		echo; \
		echo '; Ensure worker stdout and stderr are sent to the main error log.'; \
		echo 'catch_workers_output = yes'; \
		echo 'decorate_workers_output = no'; \
	} | tee php-fpm.d/docker.conf \
	&& { \
		echo '[global]'; \
		echo 'daemonize = no'; \
		echo; \
		echo '[www]'; \
		echo 'listen = /var/run/php-fpm/fpm.sock'; \
		echo 'listen.mode = 666'; \
	} | tee php-fpm.d/zz-docker.conf \
	&& mkdir -p /var/run/php-fpm && chmod 777 /var/run/php-fpm

# Command that launches Apache and FPM simultaneously
RUN	{ \
		echo '#!/bin/bash'; \
		echo 'if [ -z "$APACHE_KEEP_MODS" ]; then'; \
		echo '  a2dismod -q mpm_prefork php7 && a2enmod -q mpm_event proxy_fcgi || exit 1'; \
		echo 'fi'; \
		echo 'php-fpm $FPM_ARGS &'; \
		echo 'apache2-foreground -DFPM $APACHE_ARGS &'; \
		echo; \
		echo 'trap "stopped=1" TERM INT'; \
		echo 'wait -n					# wait until container is stopped, or a process exits'; \
		echo 'kill %1 %2 2> /dev/null			# send sigterm to remaining processes'; \
		echo 'if [ -z "$stopped" ]; then exit 2; fi	# if it was a crash, container fails immediately'; \
		echo 'until wait; do true; done			# otherwise, wait for processes to finish'; \
	} | tee /usr/local/bin/apache-fpm \
	&& chmod +x /usr/local/bin/apache-fpm

EXPOSE 80
CMD ["apache2-foreground"]
